<title>通话记录</title>
<style>
    .layui-form-item {
        width: 400px;
        margin: 20px auto;
    }

    .layui-form-label {
        width: 100px;
    }
</style>


<!-- <div class="layui-fluid" style="box-sizing: border-box;"> -->

<div class="layui-card" style="height:100%">
    <!-- <div class="layui-card-header">
            新建任务
        </div> -->
    <div class="layui-card-body">
        <!--主体信息-->
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 10px;">
            <legend>任务向导</legend>
        </fieldset>
        <div id="step_demo" class="step-body" style="height: 100%;">
            <div class="step-header" style="width:90%;overflow: hidden;margin-bottom: 30px;">
                <ul>
                    <li>
                        <span class="step-name">建立任务</span>
                    </li>
                    <li>
                        <span class="step-name">设置任务限制</span>
                    </li>
                    <li>
                        <span class="step-name">分配任务</span>
                    </li>
                    <li>
                        <span class="step-name">上传任务话单</span>
                    </li>
                    <li>
                        <span class="step-name">完成</span>
                    </li>
                </ul>
            </div>
            <!-- <div class="layui-form" lay-filter="form" style="height: 100%;"> -->
            <div class="step-content layui-form" lay-filter="form" style="height: 100%;">
                <div class="step-list">
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务ID：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="TaskID" autocomplete="off" placeholder="" class="layui-input"
                                readonly style="cursor: no-drop;">
                        </div>
                    </div>
                    <div class="layui-form-item layui-hide">
                        <label class="layui-form-label">任务ID：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="TaskStatus" autocomplete="off" placeholder="" class="layui-input"
                                readonly style="cursor: no-drop;" value="true">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">部门ID：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="DepartmentID" autocomplete="off" placeholder="" class="layui-input"
                                readonly style="cursor: no-drop;">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">部门名称：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="DepartmentName" autocomplete="off" placeholder=""
                                class="layui-input" readonly style="cursor: no-drop;">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务添加人：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="AddPeople" autocomplete="off" placeholder="" class="layui-input"
                                readonly style="cursor: no-drop;">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务名称：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="TaskName" autocomplete="off" placeholder="" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务开始日期：</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" name="TaskStartDate" id="TaskStartDate"
                                placeholder="yyyy-MM-dd" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务结束日期：</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" name="TaskEndDate" id="TaskEndDate"
                                placeholder="yyyy-MM-dd" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务开始时间：</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" name="MissionStartTime" id="MissionStartTime"
                                placeholder="HH-mm-ss" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务结束时间：</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" name="TaskOverTime" id="TaskOverTime"
                                placeholder="HH-mm-ss" lay-verify="required">
                        </div>
                    </div>
                    <div class="layui-input-block" style="text-align: center; margin-left:0">
                        <button type="button" class="layui-btn button" id="one">下一步</button>
                    </div>
                </div>
                <div class="step-list">
                    <div class="layui-form-item">
                        <label class="layui-form-label">日呼叫总数：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="TotalNumberOfDaysCall" id="TotalNumberOfDaysCall"
                                autocomplete="off" placeholder="" class="layui-input" lay-verify="required">
                        </div>
                        <div class="layui-form-mid layui-word-aux" style="font-size: 16px;color: black;">次/日
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">呼叫间隔：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="CallBetween" autocomplete="off" id="CallBetween" placeholder=""
                                class="layui-input" lay-verify="required" value="30">
                        </div>
                        <div class="layui-form-mid layui-word-aux" style="font-size: 16px;color: black;">秒</div>
                    </div>
                    <div class="layui-input-block" style="text-align: center; margin-left:0">
                        <button type="button" class="layui-btn button" id="two">下一步</button>
                    </div>
                </div>
                <div class="step-list">
                    <div class="layui-form-item">
                        <label class="layui-form-label">任务执行人：</label>
                        <div class="layui-input-inline">
                            <select class="TaskExecutor" lay-verify="required" name="TaskExecutor"
                                lay-filter="TaskExecutor">

                            </select>
                        </div>
                    </div>
                    <div class="layui-input-block" style="text-align: center; margin-left:0">
                        <button type="button" class="layui-btn button" id="three">下一步</button>
                    </div>
                </div>
                <div class="step-list" style="text-align: center;">
                    <div style="margin-top: 30px;margin-bottom: 50px;">
                        <button type="button" class="layui-btn" id="upload"><i class="layui-icon"></i>上传文件</button>
                        <button type="button" class="layui-btn" id="cancel">取消</button>
                    </div>
                    <table id="DataTable" filtter="DataTable" class="layui-hide"></table>
                    <div class="layui-input-block"
                        style="text-align: center; margin-left:0; margin-top: 30px; margin-bottom: 70px;">
                        <button type="button" class="layui-btn button" id="four">下一步</button>
                    </div>
                </div>
                <div class="step-list"></div>
                <div class="step-list" style="text-align: center;">
                    <div class="card-panel"
                        style="margin-bottom: 15px; display: flex;width: 440px;height: 180px;justify-content: center; margin: 150px auto 50px;">
                        <div class="card-panel-icon-wrapper"
                            style="display: flex;align-items: center;justify-content: center;">
                            <i class="layui-icon layui-icon-ok-circle" style="font-size: 200px; color: green;"></i>
                        </div>
                        <div class="card-panel-description" style="display: flex;
                        flex-direction: column;
                        justify-content: space-around;">
                            <div class="card-panel-text" style="font-size: 24px;height: 60px;
                            line-height: 60px;">
                                分配完成
                            </div>
                            <div style="font-size: 16px;
                            height: 60px;
                            line-height: 60px;">
                                点击完成，查看任务列表
                            </div>
                        </div>
                        <div class="layui-form-item layui-hide">
                            <input type="button" lay-submit="123" lay-filter="LAY-user-front-submit"
                                id="LAY-user-front-submit" value="确认">
                        </div>
                    </div>
                    <div class="layui-input-block" style="text-align: center; margin-left:0;margin-bottom: 50px;">
                        <!-- <button type="button" class="layui-btn layui-btn-primary back" id="look">回退</button> -->
                        <button type="button" class="layui-btn button" id="look"
                            onclick="location.hash = '/teamleader/TaskList'">完成</button>
                    </div>
                </div>
                <!-- </div> -->
            </div>
        </div>
    </div>
    <!-- </div> -->


    <script>
        layui.use(['element', "upload", 'form', 'table', "steps", "excel", "laydate"], function () {
            var element = layui.element;
            var upload = layui.upload;
            var table = layui.table;
            var steps = layui.steps;
            var excel = layui.excel;
            var form = layui.form;
            var laydate = layui.laydate;

            var TL = null;
            var file = null
            var formData = null

            $.ajax({
                method: "get",
                url: "http://voip.winsource.cn:9090/app/AutoTask/AutoTask.ashx?fun=SeatList", //"http://voip.winsource.cn:9090/app/AutoTask/AutoTask.ashx?fun=AutoTaskAdd"
                data: {
                    DepartmentID: sessionStorage.getItem("DepartmentID")
                },
                success: function (res) {
                    var JsonRes = JSON.parse(res)
                    var select = $('.TaskExecutor')
                    select.empty()
                    for (let i = 0; i < JsonRes.length; i++) {
                        select.append(`<option value="${JsonRes[i].ExtensionNumber}">${JsonRes[i].SeatUserName}</option>`)
                    }
                    form.render()
                }
            })

            form.render()

            form.val("form", {
                TaskID: sessionStorage.getItem("DepartmentID") + new Date().valueOf(),
                DepartmentID: sessionStorage.getItem("DepartmentID"),
                DepartmentName: sessionStorage.getItem("DepartmentName"),
                AddPeople: sessionStorage.getItem("SeatName")
            });

            laydate.render({
                elem: "#TaskStartDate"
            })
            laydate.render({
                elem: "#TaskEndDate"
            })
            laydate.render({
                elem: "#MissionStartTime",
                type: 'time'
            })
            laydate.render({
                elem: "#TaskOverTime",
                type: 'time'
            })

            var $step = $("#step_demo").step();
            $('.jump-steps').off('click')

            form.on('submit(LAY-user-front-submit)', function (data) {
                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });

            $('.button').click(function () {
                var ID   = $(this).attr('id')
                var S = $("#MissionStartTime").val().split(':')[0]
                var E = $("#TaskOverTime").val().split(':')[0]
                console.log(S, E);
                switch (ID) {
                    case "one":
                        if ($("#TaskStartDate").val() && $("#TaskEndDate").val() && $("#MissionStartTime").val() && $("#TaskOverTime").val()) {
                            if (S < E) {
                                $step.nextStep();//下一步
                            } else {
                                layer.msg("开始时间不得大于结束时间，且最小间隔为10分钟")
                            }
                        } else {
                            $("#LAY-user-front-submit").click()
                        }
                        break;
                    case "two":
                        if ($("#TotalNumberOfDaysCall").val() && $("#CallBetween").val() && $("#CallBetween").val() >= 30) {
                            $step.nextStep();//下一步
                        } else {
                            if($("#CallBetween").val() < 30){
                                layer.msg("最小呼叫间隔为30秒")
                            }
                            $("#LAY-user-front-submit").click()
                        }
                        break;
                    case "three":
                        formData = form.val("form");
                        var Thres = form.val("form");
                        delete Thres["file"]
                        Thres = JSON.stringify(Thres)
                        $.ajax({
                            method: "post",
                            url: "http://voip.winsource.cn:9090/app/AutoTask/AutoTask.ashx?fun=AutoTaskAdd",
                            data: {
                                data: Thres
                            },
                            success: function (res) {
                                var res = JSON.parse(res)
                                if (res.code == 200) {
                                    layer.msg("添加任务成功，请上传列表")
                                    $step.nextStep();//下一步
                                } else {
                                    layer.msg("添加任务失败，请刷新后再试")
                                }
                            }
                        })
                        break;
                    case "four":
                        $step.nextStep();//下一步
                        // console.log(form.val("form"));
                        break;
                    default:
                        // console.log($step);
                        break;
                }
            })
            var load = null
            upload.render({
                elem: '#upload',
                url: 'http://voip.winsource.cn:9090/app/AutoTask/Up.ashx', //改成您自己的上传接口
                accept: 'file', //普通文件
                auto: false,
                // method: "get",
                bindAction: '#four',
                before: function () {
                    load = layer.msg('上传中', {
                        icon: 16
                        , shade: 0.3
                    });
                    this.data = {
                        UserID: formData.TaskExecutor,
                        TaskID: formData.TaskID
                    }
                },
                choose: function (obj) {
                    //将每次选择的文件追加到文件队列
                    file = obj.pushFile();
                    var files = obj.pushFile();
                    //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                    obj.preview(function (index, file, result) {
                        var files = [file]
                        try {
                            excel.importExcel(files, {
                                fields: {
                                    'username': 'A'
                                    , 'usertel': 'B'
                                    , 'adduser': 'C'
                                    , 'remark': 'D'
                                    , 'address': 'E'
                                }
                            }, function (data) {
                                let res = Object.values(data[0])[0]
                                res.shift()
                                $('#DataTable').show()
                                TL = table.render({
                                    elem: '#DataTable',
                                    page: true,
                                    limit: 10,
                                    loading: true,
                                    data: res,
                                    cols: [[
                                        { field: 'username', title: '客户名' },
                                        { field: 'usertel', title: '客户电话' },
                                        { field: 'adduser', title: '添加人' },
                                        { field: 'address', title: '地址' },
                                        { field: 'remark', title: '备注' }
                                    ]]
                                });
                            });
                        } catch (e) {
                            layer.close(load)
                            layer.alert(e.message);
                            return false
                        }

                        $('#cancel').click(function () {
                            layer.confirm('是否取消上传当前文件？', {
                                btn: ['确定', '取消'] //按钮
                            }, function () {
                                delete files[index]
                                TL.reload({ data: [] })
                                $('#DataTable').hide()
                                layer.close(load)

                            });
                        })
                    });
                },
                done: function (res, index, upload) {
                    if (res.code == 200) {
                        layer.close(load)
                        $step.nextStep();
                    } else {
                        layer.closeAll()
                        layer.msg("导入失败，取消后重试")
                    }
                }
            })
        });


    </script>